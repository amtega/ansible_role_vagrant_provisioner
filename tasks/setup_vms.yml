---
# Setup vagrant vms

- set_fact:
    vm_path: >-
      {{ vms_directory | expanduser }}/virtual_machines/{{ vm.subdirectory }}

- name: "({{ vm.hostname }}) create vagrant vm directories"
  file:
    path: >-
      {{ vm_path }}
    state: directory
    force: yes
    recurse: yes

- name: "({{ vm.hostname }}) create vagrant file"
  template:
    src: Vagrantfile.j2
    dest: >-
      {{ vm_path }}/Vagrantfile
    force: yes
    backup: yes
  register: result_vagrantfile

- name: "({{ vm.hostname }}) vagrant status"
  shell: "vagrant status --machine-readable"
  become: true
  args:
    chdir: >-
      {{ vm_path }}
  changed_when: false
  register: result_vagrant_status

- name: "({{ vm.hostname }}) vagrant destroy"
  shell: "vagrant destroy --machine-readable"
  become: true
  args:
    chdir: >-
      {{ vm_path }}
  when: >-
    result_vagrantfile.changed
    and ',state,not_created' not in result_vagrant_status.stdout
  failed_when: false

  # TODO: stop running machines not listed in vagrant or virsh list
  # and erase its /var/lib/libvirt/images/* images (!?!)

- name: "({{ vm.hostname }}) vagrant up"
  shell: "vagrant up --machine-readable"
  register: result_vagrant_up
  become: true
  args:
    chdir: >-
      {{ vm_path }}
  when: >-
    ',state,not_created' in result_vagrant_status.stdout
  changed_when: >
    result_vagrant_up.rc == 0
    and not "Machine already provisioned." in result_vagrant_up.stdout
  failed_when: >-
    ',ui,error,' in result_vagrant_up.stdout
    or result_vagrant_up.rc == 1

- name: "({{ vm.hostname }}) get vm ip address"
  shell: "vagrant ssh-config"
  register: result_vagrant_ssh_config
  become: true
  args:
    chdir: >-
      {{ vm_path }}
  changed_when: false

- debug:
    var: result_vagrant_ssh_config
- debug:
    msg: >-
      IP:{{ result_vagrant_ssh_config.stdout_lines[1][11:] }}
- debug:
    # https://docs.python.org/2/library/re.html#regular-expression-syntax
    # (?s) "dot matches all"
    # (?m) "multi line"
    msg: >-
      IdentityFile:{{ result_vagrant_ssh_config.stdout | regex_replace('^(?sm).*\n *IdentityFile *(?P<identityfile>[^\n]+)\n.*$', '\1') }}

