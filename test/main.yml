---
# Tasks for tesing role

- name: test the role vagrant_engine
  hosts: localhost

  roles:
  # Provision virtual machines
  - &yaml_alias__provision
    role: ansible_vagrant_provisioner
    vagrant_provisioner_banner_message: Provision virtual machines
    vagrant_provisioner_boxes:
    - name: "centos/7"
      state: present
      provider: "libvirt"
    - name: "fedora/26-cloud-base"
      state: present
      provider: "libvirt"
    vagrant_provisioner_vms:
    - name: "centos_7"
      state: present
      hostname: "centos-7"
      subdirectory: "centos_7"
      box:
        name: "centos/7"
        provider: "libvirt"
      driver: kvm
      memory: 1024
      cpus: 1
    - name: "fedora_26_cloud_base"
      state: present
      hostname: "fedora-26-cloud-base"
      subdirectory: "fedora_26_cloud_base"
      box:
        name: "fedora/26-cloud-base"
        provider: "libvirt"
      driver: kvm
      memory: 1024
      cpus: 1

  # Idempotence test - Provision virtual machines
  - <<: *yaml_alias__provision
    vagrant_provisioner_banner_message: (Idempotence test) Provision virtual machines

- name: Ping new hosts
  hosts: vagrant_vm
  become_user: vagrant
  tasks:
    - ping:
    - ping: null
    - ping: ~

  # Cleanup provisioned vms
  - &yaml_alias__cleanup_vms
    role: ansible_vagrant_provisioner
    vagrant_provisioner_banner_message: Cleanup provisioned virtual machines
    vagrant_provisioner_vms:
    - name: "centos_7"
      state: absent
      hostname: "centos-7"
      subdirectory: "centos_7"
    - name: "fedora_26_cloud_base"
      state: absent
      hostname: "fedora-26-cloud-base"
      subdirectory: "fedora_26_cloud_base"

  # Idempotence test - Cleanup provisioned vms
  - <<: *yaml_alias__cleanup_vms
    vagrant_provisioner_banner_message: (Idempotence test) Cleanup provisioned virtual machines

  # TODO: ping the vms
  # TODO: ssh into the vms

  # Cleanup provisioned boxes
  - &yaml_alias__cleanup_boxes
    role: ansible_vagrant_provisioner
    vagrant_provisioner_banner_message: Cleanup provisioned boxes
    vagrant_provisioner_boxes:
    - name: "centos/7"
      state: absent
      provider: "libvirt"
    - name: "fedora/26-cloud-base"
      state: absent
      provider: "libvirt"

  # Idempotence test - Cleanup provisioned vms
  - <<: *yaml_alias__cleanup_boxes
    vagrant_provisioner_banner_message: (Idempotence test) Cleanup provisioned boxes
