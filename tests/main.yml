---
# Tasks for tesing role

- name: load vagrant presets and configure testing environment
  hosts: localhost
  roles:
    - role: amtega.vagrant_presets
  tasks:
    - name: setup vagrant_provisioner variables
      set_fact:
        vagrant_provisioner_boxes: "{{ vagrant_presets_boxes }}"
        vagrant_provisioner_vms: >-
          {{ vagrant_presets_vms | vagrant_presets_randomize_names }}

- name: test boxes and vms provisioning
  hosts: localhost
  roles:
    - role: amtega.vagrant_provisioner
      vagrant_provisioner_box_state: present
      vagrant_provisioner_vm_state: present

- name: ping provisioned vms
  gather_facts: false
  hosts: vagrant_provisioner_vms
  become_user: vagrant
  tasks:
    - name: ping the vm
      ping:
    - name: shell into the vm
      shell: "cat /etc/*release*"
      changed_when: false
      register: shell_into_vm_result

- name: test boxes and vms cleanup
  hosts: localhost
  roles:
    - role: amtega.vagrant_provisioner
      vagrant_provisioner_box_state: absent
      vagrant_provisioner_vm_state: absent
